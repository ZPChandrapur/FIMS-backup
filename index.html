<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FIMS - Field Inspection Management System</title>
    <script>
      // Load the Google Maps JavaScript API
      // The key is essential for authentication.
      (g => {
        var h, a, k, p = "The Google Maps JavaScript API",
          c = "google",
          l = "importLibrary",
          q = "__ib__",
          m = document,
          b = window;
        b = b[c] || (b[c] = {});
        var d = b.maps || (b.maps = {}),
          r = new Set,
          e = new URLSearchParams,
          u = () => h || (h = new Promise(async (f, n) => {
            await (a = m.createElement("script"));
            e.set("libraries", [...r] + "");
            for (k in g) e.set(k.replace(/[A-Z]/g, t => "_" + t[0].toLowerCase()), g[k]);
            e.set("callback", c + ".maps." + q);
            a.src = `https://maps.${
    c}apis.com/maps/api/js?` + e;
            d[q] = f;
            a.onerror = () => h = n(Error(p + " could not load."));
            a.nonce = m.querySelector("script[nonce]")?.nonce || "";
            m.head.append(a)
          }));
        d[l] ? console.warn(p + " only loads once. Ignoring:", g) : d[l] = (f, ...n) => r.add(f) && u().then(() => d[l](f, ...n))
      })({
        key: "AIzaSyDzOjsiqs6rRjSJWVdXfUBl4ckXayL8AbE", // <--- REPLACE WITH YOUR ACTUAL API KEY
        v: "beta" // Using the beta channel for latest features like Advanced Markers
      });

      let geocoder; // Declare geocoder globally or within an appropriate scope

      async function initializeGeocoder() {
        if (!geocoder) { // Initialize only once
          await google.maps.importLibrary("geocoding");
          geocoder = new google.maps.Geocoder();
        }
      }

      function updateStatus(message) {
        document.getElementById('status').innerText = message;
      }

      function displayAddress(address) {
        document.getElementById('address-display').innerText = address;
      }

      async function getLocationAndAddress() {
        updateStatus("Attempting to get your location...");
        displayAddress(""); // Clear previous address

        // First, ensure the Geocoding library is loaded and geocoder is initialized
        await initializeGeocoder();

        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (position) => {
              const lat = position.coords.latitude;
              const lng = position.coords.longitude;
              updateStatus(`Location found: Lat ${lat}, Lng ${lng}. Getting address...`);
              reverseGeocode(lat, lng);
            },
            (error) => {
              // Handle common errors from Geolocation API
              switch (error.code) {
                case error.PERMISSION_DENIED:
                  updateStatus("Error: Geolocation permission denied by the user.");
                  break;
                case error.POSITION_UNAVAILABLE:
                  updateStatus("Error: Location information is unavailable.");
                  break;
                case error.TIMEOUT:
                  updateStatus("Error: The request to get user location timed out.");
                  break;
                case error.UNKNOWN_ERROR:
                  updateStatus("Error: An unknown geolocation error occurred.");
                  break;
              }
              displayAddress("Could not retrieve your address.");
            }, {
              enableHighAccuracy: true, // Request the most accurate position available
              timeout: 10000, // Maximum time (in milliseconds) to wait for a position
              maximumAge: 60000 // Maximum age (in milliseconds) of a possible cached position
            }
          );
        } else {
          updateStatus("Geolocation is not supported by this browser.");
          displayAddress("Your browser does not support Geolocation.");
        }
      }

      function reverseGeocode(lat, lng) {
        const latlng = {
          lat: lat,
          lng: lng
        };

        geocoder.geocode({
          'location': latlng
        }, (results, status) => {
          if (status === 'OK') {
            if (results[0]) {
              updateStatus("Address found successfully!");
              displayAddress(results[0].formatted_address);
            } else {
              updateStatus("No address results found for this location.");
              displayAddress("No address found.");
            }
          } else {
            updateStatus('Geocoder failed due to: ' + status);
            displayAddress("Error finding address.");
          }
        });
      }
    </script>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>